<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ•ã‚©ãƒˆãƒ–ãƒƒã‚¯ç®¡ç† - HTMLç‰ˆ</title>

    <!-- EXIF.js ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼ˆCDNï¼‰ -->
    <script src="https://cdn.jsdelivr.net/npm/exif-js@2.3.0/exif.min.js"></script>

    <style>
        /* ãƒªã‚»ãƒƒãƒˆã¨ãƒ™ãƒ¼ã‚¹ã‚¹ã‚¿ã‚¤ãƒ« */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            overflow: hidden;
        }

        /* ã‚¢ãƒ—ãƒªã‚³ãƒ³ãƒ†ãƒŠ */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .app-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .app-header h1 {
            font-size: 20px;
            font-weight: 600;
        }

        /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
            gap: 10px;
            padding: 10px;
        }

        /* ãƒšã‚¤ãƒ³å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
        .left-pane, .center-pane, .right-pane {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .left-pane {
            flex: 2;
        }

        .center-pane {
            flex: 1;
            min-width: 300px;
        }

        .right-pane {
            flex: 2;
        }

        /* ãƒšã‚¤ãƒ³ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .pane-header {
            padding: 15px 20px;
            border-bottom: 2px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .pane-header h2 {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        /* ãƒœã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ« */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            outline: none;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .btn-primary {
            background-color: #2196F3;
            color: white;
        }

        .btn-success {
            background-color: #4CAF50;
            color: white;
        }

        .btn-danger {
            background-color: #FF5722;
            color: white;
        }

        .btn-danger:disabled {
            background-color: #BDBDBD;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background-color: #9E9E9E;
            color: white;
        }

        .btn-info {
            background-color: #673AB7;
            color: white;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        /* ãƒ•ã‚©ãƒ«ãƒ€ãƒ‘ã‚¹ */
        .folder-path {
            padding: 10px 20px;
            color: #666;
            font-size: 11px;
            background-color: #f9f9f9;
            border-bottom: 1px solid #e0e0e0;
        }

        /* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¡Œ */
        .action-row {
            padding: 10px 20px;
            border-bottom: 1px solid #e0e0e0;
        }

        /* ãƒ˜ãƒ«ãƒ—ãƒ†ã‚­ã‚¹ãƒˆ */
        .help-text {
            padding: 5px 20px;
            color: #666;
            font-size: 10px;
            font-style: italic;
        }

        /* ã‚½ãƒ¼ãƒˆã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« */
        .sort-control {
            padding: 10px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid #e0e0e0;
        }

        .sort-control label {
            font-size: 13px;
            font-weight: 500;
        }

        .sort-control select {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }

        /* ã‚µãƒ ãƒã‚¤ãƒ«ã‚°ãƒªãƒƒãƒ‰ */
        .thumbnail-grid {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 15px;
            align-content: start;
        }

        /* ã‚µãƒ ãƒã‚¤ãƒ«ã‚¢ã‚¤ãƒ†ãƒ  */
        .thumbnail-item {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .thumbnail-item:hover {
            border-color: #2196F3;
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.2);
        }

        .thumbnail-item.selected {
            border-color: #2196F3;
            background-color: #E3F2FD;
            border-width: 3px;
        }

        .thumbnail-image {
            width: 200px;
            height: 200px;
            object-fit: contain;
            background-color: #f0f0f0;
            border-radius: 4px;
            display: block;
            margin: 0 auto;
        }

        .thumbnail-name {
            margin-top: 8px;
            font-size: 11px;
            word-wrap: break-word;
            text-align: center;
        }

        .thumbnail-datetime {
            margin-top: 4px;
            font-size: 10px;
            color: #666;
            text-align: center;
        }

        /* ãƒã‚¹ã‚±ãƒƒãƒˆãƒªã‚¹ãƒˆ */
        .basket-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .basket-item {
            padding: 10px;
            margin-bottom: 8px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            background: white;
        }

        .basket-item:hover {
            background-color: #f5f5f5;
        }

        .basket-item.selected {
            background-color: #E3F2FD;
            border-color: #2196F3;
        }

        .basket-item-text {
            font-size: 13px;
        }

        /* ãƒã‚¹ã‚±ãƒƒãƒˆã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« */
        .basket-controls {
            padding: 10px;
            display: flex;
            gap: 5px;
            border-top: 1px solid #e0e0e0;
            border-bottom: 1px solid #e0e0e0;
        }

        .basket-controls .btn {
            flex: 1;
        }

        /* ãƒ©ãƒ™ãƒ«é©ç”¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .label-apply-section {
            padding: 10px;
            display: flex;
            align-items: center;
            gap: 5px;
            border-bottom: 1px solid #e0e0e0;
        }

        .label-apply-section label {
            font-size: 12px;
            white-space: nowrap;
        }

        .label-apply-section input {
            flex: 1;
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }

        /* ã‚«ã‚¦ãƒ³ãƒˆãƒ©ãƒ™ãƒ« */
        .count-label {
            padding: 10px;
            color: #666;
            font-size: 13px;
        }

        /* ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .template-section {
            padding: 15px 20px;
            border-bottom: 1px solid #e0e0e0;
        }

        .template-section label {
            display: block;
            margin-bottom: 8px;
            font-size: 13px;
            font-weight: 500;
        }

        .template-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        /* ãƒ—ãƒªã‚»ãƒƒãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .preset-section {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid #e0e0e0;
        }

        .preset-section label {
            font-size: 13px;
            font-weight: 500;
            white-space: nowrap;
        }

        .preset-section select {
            flex: 1;
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }

        /* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ */
        .action-buttons {
            padding: 15px 20px;
            display: flex;
            gap: 10px;
        }

        .action-buttons .btn {
            flex: 1;
        }

        /* JSONå‡ºåŠ›ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .json-export-section {
            padding: 10px 20px;
            border-bottom: 1px solid #e0e0e0;
        }

        /* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .preview-section {
            padding: 15px 20px;
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .preview-section h3 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .preview-table-wrapper {
            flex: 1;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
        }

        .preview-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .preview-table thead {
            background-color: #f5f5f5;
            position: sticky;
            top: 0;
        }

        .preview-table th {
            padding: 10px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #e0e0e0;
        }

        .preview-table td {
            padding: 8px 10px;
            border-bottom: 1px solid #f0f0f0;
        }

        .preview-table tr:hover {
            background-color: #f9f9f9;
        }

        .preview-table .warning {
            background-color: #FFEB3B;
        }

        .preview-table .success {
            background-color: #C8E6C9;
        }

        /* ãƒ­ã‚°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .log-section {
            padding: 15px 20px;
        }

        .log-section h3 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .log-view {
            height: 150px;
            overflow-y: auto;
            padding: 10px;
            background-color: #f9f9f9;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
        }

        .log-message {
            margin-bottom: 5px;
            line-height: 1.4;
        }

        .log-message.error {
            color: #D32F2F;
            font-weight: 600;
        }

        .log-message.warning {
            color: #F57C00;
        }

        .log-message.info {
            color: #333;
        }

        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º */
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
            font-style: italic;
        }

        /* éš ã—ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ› */
        #folderInput {
            display: none;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <header class="app-header">
            <h1>ğŸ“· ãƒ•ã‚©ãƒˆãƒ–ãƒƒã‚¯ç®¡ç† - ç”»åƒãƒªãƒãƒ¼ãƒ ãƒ„ãƒ¼ãƒ« (HTMLç‰ˆ)</h1>
        </header>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <div class="main-content">
            <!-- å·¦ãƒšã‚¤ãƒ³: ã‚µãƒ ãƒã‚¤ãƒ«ã‚°ãƒªãƒƒãƒ‰ -->
            <div class="left-pane">
                <div class="pane-header">
                    <h2>ç”»åƒãƒ•ã‚©ãƒ«ãƒ€</h2>
                    <button id="openFolderBtn" class="btn btn-primary">ğŸ“ ãƒ•ã‚©ãƒ«ãƒ€ã‚’é–‹ã</button>
                </div>

                <div class="folder-path" id="folderPath">ãƒ•ã‚©ãƒ«ãƒ€ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“</div>

                <div class="action-row">
                    <button id="addToBasketBtn" class="btn btn-success">â• é¸æŠã‚’ãƒã‚¹ã‚±ãƒƒãƒˆã«è¿½åŠ </button>
                </div>

                <div class="help-text">Ctrl+ã‚¯ãƒªãƒƒã‚¯ã§è¤‡æ•°é¸æŠã€Shift+ã‚¯ãƒªãƒƒã‚¯ã§ç¯„å›²é¸æŠ â†’ ãƒœã‚¿ãƒ³ã§ä¸€æ‹¬è¿½åŠ  â†’ æ•°å­—ã‚­ãƒ¼ã§ãƒ©ãƒ™ãƒ«é©ç”¨</div>

                <!-- ã‚½ãƒ¼ãƒˆã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
                <div class="sort-control">
                    <label>ä¸¦ã³æ›¿ãˆ:</label>
                    <select id="sortMode">
                        <option value="exif_asc">æ’®å½±æ—¥æ™‚ï¼ˆæ˜‡é †ï¼‰</option>
                        <option value="exif_desc">æ’®å½±æ—¥æ™‚ï¼ˆé™é †ï¼‰</option>
                        <option value="name">ãƒ•ã‚¡ã‚¤ãƒ«å</option>
                    </select>
                </div>

                <!-- ã‚µãƒ ãƒã‚¤ãƒ«ã‚°ãƒªãƒƒãƒ‰ -->
                <div class="thumbnail-grid" id="thumbnailGrid">
                    <div class="loading">ãƒ•ã‚©ãƒ«ãƒ€ã‚’é–‹ããƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„</div>
                </div>

                <!-- éš ã—ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ› -->
                <input type="file" id="folderInput" webkitdirectory directory multiple />
            </div>

            <!-- ä¸­å¤®ãƒšã‚¤ãƒ³: é¸æŠãƒã‚¹ã‚±ãƒƒãƒˆ -->
            <div class="center-pane">
                <div class="pane-header">
                    <h2>é¸æŠãƒã‚¹ã‚±ãƒƒãƒˆï¼ˆé¸ã‚“ã é †ï¼‰</h2>
                </div>

                <!-- ãƒã‚¹ã‚±ãƒƒãƒˆãƒªã‚¹ãƒˆ -->
                <div class="basket-list" id="basketList">
                    <div class="loading">ãƒã‚¹ã‚±ãƒƒãƒˆã¯ç©ºã§ã™</div>
                </div>

                <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ -->
                <div class="basket-controls">
                    <button id="moveUpBtn" class="btn btn-sm">â–² ä¸Šã¸</button>
                    <button id="moveDownBtn" class="btn btn-sm">â–¼ ä¸‹ã¸</button>
                    <button id="removeBtn" class="btn btn-sm">ğŸ—‘ï¸ å‰Šé™¤</button>
                    <button id="clearBasketBtn" class="btn btn-sm">ğŸ—‘ï¸ ã™ã¹ã¦ã‚¯ãƒªã‚¢</button>
                </div>

                <!-- ãƒ©ãƒ™ãƒ«ä¸€æ‹¬é©ç”¨ -->
                <div class="label-apply-section">
                    <label>ãƒ©ãƒ™ãƒ«ä¸€æ‹¬é©ç”¨:</label>
                    <input type="text" id="labelInput" placeholder="å…¨æ™¯">
                    <button id="applyLabelBtn" class="btn btn-sm btn-primary">é©ç”¨</button>
                </div>

                <!-- ã‚«ã‚¦ãƒ³ãƒˆè¡¨ç¤º -->
                <div class="count-label" id="countLabel">é¸æŠæ•°: 0</div>
            </div>

            <!-- å³ãƒšã‚¤ãƒ³: æ“ä½œã¨ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
            <div class="right-pane">
                <div class="pane-header">
                    <h2>ãƒªãƒãƒ¼ãƒ è¨­å®š</h2>
                </div>

                <!-- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå…¥åŠ› -->
                <div class="template-section">
                    <label>ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ:</label>
                    <input type="text" id="templateInput" value="V-{seq:1}_{label}" class="template-input">
                    <div class="help-text">å¤‰æ•°: {group}=ã‚°ãƒ«ãƒ¼ãƒ—ç•ªå·, {label}=ãƒ©ãƒ™ãƒ«, {seq:003}=é€£ç•ªï¼ˆã‚¼ãƒ­åŸ‹ã‚3æ¡ï¼‰</div>

                    <label style="margin-top: 10px;">é€£ç•ªé–‹å§‹ç•ªå·:</label>
                    <input type="number" id="seqStartInput" value="1" min="1" class="template-input" style="width: 150px;">
                    <div class="help-text">é€”ä¸­ã‹ã‚‰é–‹å§‹ã™ã‚‹å ´åˆã«ç•ªå·ã‚’å¤‰æ›´ã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼š51ï¼‰</div>
                </div>

                <!-- ãƒ©ãƒ™ãƒ«ãƒ—ãƒªã‚»ãƒƒãƒˆ -->
                <div class="preset-section">
                    <label>ãƒ©ãƒ™ãƒ«ãƒ—ãƒªã‚»ãƒƒãƒˆ:</label>
                    <select id="presetCombo">
                        <option value="å…¨æ™¯">1. å…¨æ™¯</option>
                        <option value="æ¥å†™">2. æ¥å†™</option>
                        <option value="å†…éƒ¨">3. å†…éƒ¨</option>
                        <option value="æ¸¬å®š">4. æ¸¬å®š</option>
                        <option value="è©³ç´°">5. è©³ç´°</option>
                        <option value="å¤–è¦³">6. å¤–è¦³</option>
                    </select>
                    <button id="applyPresetBtn" class="btn btn-sm">é¸æŠé …ç›®ã«é©ç”¨</button>
                </div>

                <div class="help-text">ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ: æ•°å­—ã‚­ãƒ¼ 1-9 ã§ãƒ©ãƒ™ãƒ«é©ç”¨ã€Deleteã§é¸æŠã‚¯ãƒªã‚¢</div>

                <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
                <div class="action-buttons">
                    <button id="previewBtn" class="btn btn-success">ğŸ‘ï¸ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>
                    <button id="executeBtn" class="btn btn-danger">âš¡ ãƒªãƒãƒ¼ãƒ å®Ÿè¡Œ</button>
                </div>

                <!-- ãƒ•ã‚©ãƒ«ãƒ€ã‹ã‚‰JSONç”Ÿæˆãƒœã‚¿ãƒ³ -->
                <div class="json-export-section">
                    <button id="generateJsonFromFolderBtn" class="btn btn-info">ğŸ“ ãƒ•ã‚©ãƒ«ãƒ€ã‹ã‚‰JSONç”Ÿæˆ</button>
                </div>

                <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ« -->
                <div class="preview-section">
                    <h3>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
                    <div class="preview-table-wrapper">
                        <table id="previewTable" class="preview-table">
                            <thead>
                                <tr>
                                    <th>æ—§ãƒ•ã‚¡ã‚¤ãƒ«å</th>
                                    <th>æ–°ãƒ•ã‚¡ã‚¤ãƒ«å</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡ŒãŒå‹•çš„ã«è¿½åŠ ã•ã‚Œã¾ã™ -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- ãƒ­ã‚°ãƒ“ãƒ¥ãƒ¼ -->
                <div class="log-section">
                    <h3>ãƒ­ã‚°</h3>
                    <div id="logView" class="log-view">
                        <!-- ãƒ­ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå‹•çš„ã«è¿½åŠ ã•ã‚Œã¾ã™ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹
        const AppState = {
            files: [],
            images: [],
            basket: [],
            selectedImages: new Set(),
            selectedBasketIndices: new Set(),
            lastClickedBasketIndex: null, // æœ€å¾Œã«ã‚¯ãƒªãƒƒã‚¯ã—ãŸãƒã‚¹ã‚±ãƒƒãƒˆã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
            labelPresets: {
                1: "å…¨æ™¯",
                2: "æ¥å†™",
                3: "å†…éƒ¨",
                4: "æ¸¬å®š",
                5: "è©³ç´°",
                6: "å¤–è¦³"
            },
            previewData: []
        };

        // ãƒ­ã‚°å‡ºåŠ›
        function log(message, level = 'info') {
            const logView = document.getElementById('logView');
            const logMessage = document.createElement('div');
            logMessage.className = `log-message ${level}`;

            const timestamp = new Date().toLocaleTimeString();
            const prefix = level === 'error' ? '[ERROR]' : level === 'warning' ? '[WARN]' : '[INFO]';

            logMessage.textContent = `${timestamp} ${prefix} ${message}`;
            logView.appendChild(logMessage);

            // è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            logView.scrollTop = logView.scrollHeight;
        }

        // EXIFæƒ…å ±ã‚’å–å¾—
        function getExifDate(file) {
            return new Promise((resolve) => {
                EXIF.getData(file, function() {
                    const dateTime = EXIF.getTag(this, "DateTimeOriginal") || EXIF.getTag(this, "DateTime");
                    if (dateTime) {
                        // EXIFæ—¥æ™‚ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ: "YYYY:MM:DD HH:MM:SS"
                        const parts = dateTime.split(' ');
                        const dateParts = parts[0].split(':');
                        const timeParts = parts[1].split(':');
                        const date = new Date(
                            parseInt(dateParts[0]),
                            parseInt(dateParts[1]) - 1,
                            parseInt(dateParts[2]),
                            parseInt(timeParts[0]),
                            parseInt(timeParts[1]),
                            parseInt(timeParts[2])
                        );
                        resolve(date);
                    } else {
                        resolve(file.lastModifiedDate || new Date(file.lastModified));
                    }
                });
            });
        }

        // ãƒ•ã‚©ãƒ«ãƒ€ã‚’é–‹ã
        document.getElementById('openFolderBtn').addEventListener('click', () => {
            document.getElementById('folderInput').click();
        });

        document.getElementById('folderInput').addEventListener('change', async (e) => {
            const files = Array.from(e.target.files);

            // ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ãƒ•ã‚£ãƒ«ã‚¿
            const imageFiles = files.filter(file =>
                file.type.startsWith('image/')
            );

            if (imageFiles.length === 0) {
                log('ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ', 'warning');
                return;
            }

            AppState.files = imageFiles;
            AppState.images = [];

            // ãƒ•ã‚©ãƒ«ãƒ€ãƒ‘ã‚¹è¡¨ç¤º
            const folderPath = imageFiles[0].webkitRelativePath.split('/')[0];
            document.getElementById('folderPath').textContent = folderPath;

            log(`${imageFiles.length}å€‹ã®ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œå‡º`);

            // ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆï¼ˆEXIFæƒ…å ±å«ã‚€ï¼‰
            for (const file of imageFiles) {
                const datetime = await getExifDate(file);

                AppState.images.push({
                    file: file,
                    name: file.name,
                    path: file.webkitRelativePath,
                    datetime: datetime,
                    size: file.size
                });
            }

            // åˆæœŸã‚½ãƒ¼ãƒˆï¼ˆæ’®å½±æ—¥æ™‚æ˜‡é †ï¼‰
            sortImages('exif_asc');

            log('ç”»åƒã®èª­ã¿è¾¼ã¿ãŒå®Œäº†ã—ã¾ã—ãŸ');
        });

        // ã‚µãƒ ãƒã‚¤ãƒ«è¡¨ç¤º
        function renderThumbnails() {
            const grid = document.getElementById('thumbnailGrid');
            grid.innerHTML = '';

            if (AppState.images.length === 0) {
                grid.innerHTML = '<div class="loading">ç”»åƒãŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }

            AppState.images.forEach((image, index) => {
                const item = document.createElement('div');
                item.className = 'thumbnail-item';
                item.dataset.index = index;

                // é¸æŠçŠ¶æ…‹ã‚’åæ˜ 
                if (AppState.selectedImages.has(image.path)) {
                    item.classList.add('selected');
                }

                // ã‚µãƒ ãƒã‚¤ãƒ«ç”»åƒ
                const img = document.createElement('img');
                img.className = 'thumbnail-image';
                img.alt = image.name;

                // FileReader ã§ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆ
                const reader = new FileReader();
                reader.onload = (e) => {
                    img.src = e.target.result;
                };
                reader.readAsDataURL(image.file);

                // ãƒ•ã‚¡ã‚¤ãƒ«å
                const name = document.createElement('div');
                name.className = 'thumbnail-name';
                name.textContent = image.name;

                // æ’®å½±æ—¥æ™‚
                const datetime = document.createElement('div');
                datetime.className = 'thumbnail-datetime';
                datetime.textContent = image.datetime ? image.datetime.toLocaleString('ja-JP') : '';

                item.appendChild(img);
                item.appendChild(name);
                item.appendChild(datetime);

                // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
                item.addEventListener('click', (e) => {
                    if (e.ctrlKey || e.metaKey) {
                        toggleImageSelection(image.path, item);
                    } else {
                        AppState.selectedImages.clear();
                        document.querySelectorAll('.thumbnail-item').forEach(el => {
                            el.classList.remove('selected');
                        });
                        AppState.selectedImages.add(image.path);
                        item.classList.add('selected');
                    }
                });

                grid.appendChild(item);
            });
        }

        function toggleImageSelection(path, element) {
            if (AppState.selectedImages.has(path)) {
                AppState.selectedImages.delete(path);
                element.classList.remove('selected');
            } else {
                AppState.selectedImages.add(path);
                element.classList.add('selected');
            }
        }

        // ã‚½ãƒ¼ãƒˆ
        document.getElementById('sortMode').addEventListener('change', (e) => {
            sortImages(e.target.value);
        });

        function sortImages(mode) {
            if (mode === 'name') {
                AppState.images.sort((a, b) => a.name.localeCompare(b.name));
            } else if (mode === 'exif_asc') {
                AppState.images.sort((a, b) => a.datetime - b.datetime);
            } else if (mode === 'exif_desc') {
                AppState.images.sort((a, b) => b.datetime - a.datetime);
            }

            renderThumbnails();
            log(`ç”»åƒã‚’ä¸¦ã³æ›¿ãˆã¾ã—ãŸ: ${mode}`);
        }

        // ãƒã‚¹ã‚±ãƒƒãƒˆã«è¿½åŠ 
        document.getElementById('addToBasketBtn').addEventListener('click', () => {
            if (AppState.selectedImages.size === 0) {
                log('ç”»åƒãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“', 'warning');
                return;
            }

            let addedCount = 0;
            AppState.selectedImages.forEach(path => {
                const image = AppState.images.find(img => img.path === path);
                if (image && !AppState.basket.find(item => item.path === path)) {
                    AppState.basket.push({
                        path: image.path,
                        name: image.name,
                        file: image.file,
                        label: 'å…¨æ™¯',
                        group: 1
                    });
                    addedCount++;
                }
            });

            renderBasket();
            log(`${addedCount}å€‹ã®ç”»åƒã‚’ãƒã‚¹ã‚±ãƒƒãƒˆã«è¿½åŠ ã—ã¾ã—ãŸ`);
        });

        // ãƒã‚¹ã‚±ãƒƒãƒˆè¡¨ç¤º
        function renderBasket() {
            const basketList = document.getElementById('basketList');
            basketList.innerHTML = '';

            if (AppState.basket.length === 0) {
                basketList.innerHTML = '<div class="loading">ãƒã‚¹ã‚±ãƒƒãƒˆã¯ç©ºã§ã™</div>';
                updateBasketCount();
                return;
            }

            AppState.basket.forEach((item, index) => {
                const basketItem = document.createElement('div');
                basketItem.className = 'basket-item';
                basketItem.dataset.index = index;

                if (AppState.selectedBasketIndices.has(index)) {
                    basketItem.classList.add('selected');
                }

                const text = document.createElement('div');
                text.className = 'basket-item-text';
                text.textContent = `${index + 1}. ${item.name} [${item.label}]`;

                basketItem.appendChild(text);

                basketItem.addEventListener('click', (e) => {
                    if (e.shiftKey && AppState.lastClickedBasketIndex !== null) {
                        // Shift+ã‚¯ãƒªãƒƒã‚¯: ç¯„å›²é¸æŠ
                        const start = Math.min(AppState.lastClickedBasketIndex, index);
                        const end = Math.max(AppState.lastClickedBasketIndex, index);

                        AppState.selectedBasketIndices.clear();
                        document.querySelectorAll('.basket-item').forEach(el => {
                            el.classList.remove('selected');
                        });

                        for (let i = start; i <= end; i++) {
                            AppState.selectedBasketIndices.add(i);
                        }

                        document.querySelectorAll('.basket-item').forEach(el => {
                            const idx = parseInt(el.dataset.index);
                            if (AppState.selectedBasketIndices.has(idx)) {
                                el.classList.add('selected');
                            }
                        });

                        log(`ãƒã‚¹ã‚±ãƒƒãƒˆå†…ã§ ${start + 1} ã‹ã‚‰ ${end + 1} ã¾ã§ç¯„å›²é¸æŠã—ã¾ã—ãŸ`);
                    } else if (e.ctrlKey || e.metaKey) {
                        // Ctrl+ã‚¯ãƒªãƒƒã‚¯: å€‹åˆ¥è¿½åŠ /å‰Šé™¤
                        toggleBasketSelection(index, basketItem);
                        AppState.lastClickedBasketIndex = index;
                    } else {
                        // é€šå¸¸ã‚¯ãƒªãƒƒã‚¯: å˜ä¸€é¸æŠ
                        AppState.selectedBasketIndices.clear();
                        document.querySelectorAll('.basket-item').forEach(el => {
                            el.classList.remove('selected');
                        });
                        AppState.selectedBasketIndices.add(index);
                        basketItem.classList.add('selected');
                        AppState.lastClickedBasketIndex = index;
                    }
                });

                basketList.appendChild(basketItem);
            });

            updateBasketCount();
        }

        function toggleBasketSelection(index, element) {
            if (AppState.selectedBasketIndices.has(index)) {
                AppState.selectedBasketIndices.delete(index);
                element.classList.remove('selected');
            } else {
                AppState.selectedBasketIndices.add(index);
                element.classList.add('selected');
            }
        }

        function updateBasketCount() {
            document.getElementById('countLabel').textContent = `é¸æŠæ•°: ${AppState.basket.length}`;
        }

        // ãƒã‚¹ã‚±ãƒƒãƒˆæ“ä½œ
        document.getElementById('moveUpBtn').addEventListener('click', () => {
            if (AppState.selectedBasketIndices.size !== 1) {
                log('1ã¤ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’é¸æŠã—ã¦ãã ã•ã„', 'warning');
                return;
            }

            const index = Array.from(AppState.selectedBasketIndices)[0];
            if (index === 0) return;

            [AppState.basket[index], AppState.basket[index - 1]] = [AppState.basket[index - 1], AppState.basket[index]];

            AppState.selectedBasketIndices.clear();
            AppState.selectedBasketIndices.add(index - 1);

            renderBasket();
        });

        document.getElementById('moveDownBtn').addEventListener('click', () => {
            if (AppState.selectedBasketIndices.size !== 1) {
                log('1ã¤ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’é¸æŠã—ã¦ãã ã•ã„', 'warning');
                return;
            }

            const index = Array.from(AppState.selectedBasketIndices)[0];
            if (index === AppState.basket.length - 1) return;

            [AppState.basket[index], AppState.basket[index + 1]] = [AppState.basket[index + 1], AppState.basket[index]];

            AppState.selectedBasketIndices.clear();
            AppState.selectedBasketIndices.add(index + 1);

            renderBasket();
        });

        document.getElementById('removeBtn').addEventListener('click', () => {
            if (AppState.selectedBasketIndices.size === 0) {
                log('å‰Šé™¤ã™ã‚‹ã‚¢ã‚¤ãƒ†ãƒ ã‚’é¸æŠã—ã¦ãã ã•ã„', 'warning');
                return;
            }

            const index = Array.from(AppState.selectedBasketIndices)[0];
            AppState.basket.splice(index, 1);
            AppState.selectedBasketIndices.clear();
            renderBasket();
            log('ã‚¢ã‚¤ãƒ†ãƒ ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
        });

        document.getElementById('clearBasketBtn').addEventListener('click', () => {
            if (AppState.basket.length === 0) return;

            if (!confirm('ãƒã‚¹ã‚±ãƒƒãƒˆã‚’ã™ã¹ã¦ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) return;

            AppState.basket = [];
            AppState.selectedBasketIndices.clear();
            renderBasket();
            clearPreview();
            log('ãƒã‚¹ã‚±ãƒƒãƒˆã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
        });

        // ãƒ©ãƒ™ãƒ«é©ç”¨
        document.getElementById('applyLabelBtn').addEventListener('click', () => {
            const label = document.getElementById('labelInput').value.trim() || 'å…¨æ™¯';
            applyLabelToSelected(label);
        });

        document.getElementById('applyPresetBtn').addEventListener('click', () => {
            const label = document.getElementById('presetCombo').value;
            applyLabelToSelected(label);
        });

        function applyLabelToSelected(label) {
            let count = 0;

            if (AppState.selectedBasketIndices.size > 0) {
                AppState.selectedBasketIndices.forEach(index => {
                    AppState.basket[index].label = label;
                    count++;
                });
            } else if (AppState.selectedImages.size > 0) {
                AppState.selectedImages.forEach(path => {
                    const item = AppState.basket.find(item => item.path === path);
                    if (item) {
                        item.label = label;
                        count++;
                    }
                });
            }

            if (count > 0) {
                renderBasket();
                log(`ãƒ©ãƒ™ãƒ« '${label}' ã‚’ ${count} å€‹ã®ã‚¢ã‚¤ãƒ†ãƒ ã«é©ç”¨ã—ã¾ã—ãŸ`);

                AppState.selectedImages.clear();
                document.querySelectorAll('.thumbnail-item').forEach(el => {
                    el.classList.remove('selected');
                });
            } else {
                log('ãƒ©ãƒ™ãƒ«ã‚’é©ç”¨ã™ã‚‹ã‚¢ã‚¤ãƒ†ãƒ ã‚’é¸æŠã—ã¦ãã ã•ã„', 'warning');
            }
        }

        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆ
        document.getElementById('previewBtn').addEventListener('click', () => {
            if (AppState.basket.length === 0) {
                log('ãƒã‚¹ã‚±ãƒƒãƒˆãŒç©ºã§ã™', 'warning');
                return;
            }

            const template = document.getElementById('templateInput').value.trim();
            if (!template) {
                log('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning');
                return;
            }

            // é€£ç•ªé–‹å§‹ç•ªå·ã‚’å–å¾—
            const seqStart = parseInt(document.getElementById('seqStartInput').value) || 1;

            AppState.previewData = [];

            AppState.basket.forEach((item, index) => {
                const oldName = item.name;
                const newName = applyTemplate(template, {
                    group: item.group,
                    label: item.label,
                    seq: seqStart + index,  // é–‹å§‹ç•ªå·ã‚’è€ƒæ…®
                    extension: getFileExtension(oldName)
                });

                AppState.previewData.push({
                    oldName: oldName,
                    newName: newName,
                    oldPath: item.path,
                    newPath: item.path.replace(oldName, newName),
                    file: item.file  // Fileã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚‚ä¿æŒ
                });
            });

            renderPreview();
            log(`${AppState.previewData.length}ä»¶ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ç”Ÿæˆã—ã¾ã—ãŸï¼ˆé–‹å§‹ç•ªå·: ${seqStart}ï¼‰`);
        });

        function applyTemplate(template, data) {
            let result = template;

            result = result.replace('{group}', data.group);
            result = result.replace('{label}', data.label);

            // {seq:NNN} å½¢å¼ã®é€£ç•ª
            const seqPattern = /\{seq:(\d+)\}/;
            const match = result.match(seqPattern);
            if (match) {
                const width = parseInt(match[1]);
                const seqStr = String(data.seq).padStart(width, '0');
                result = result.replace(seqPattern, seqStr);
            } else {
                result = result.replace('{seq}', data.seq);
            }

            if (!result.endsWith(data.extension)) {
                result += data.extension;
            }

            return result;
        }

        function getFileExtension(filename) {
            const lastDot = filename.lastIndexOf('.');
            return lastDot !== -1 ? filename.substring(lastDot) : '';
        }

        function renderPreview() {
            const tbody = document.querySelector('#previewTable tbody');
            tbody.innerHTML = '';

            AppState.previewData.forEach(row => {
                const tr = document.createElement('tr');

                const oldNameTd = document.createElement('td');
                oldNameTd.textContent = row.oldName;

                const newNameTd = document.createElement('td');
                newNameTd.textContent = row.newName;

                if (row.oldName !== row.newName) {
                    newNameTd.classList.add('success');
                }

                tr.appendChild(oldNameTd);
                tr.appendChild(newNameTd);
                tbody.appendChild(tr);
            });
        }

        function clearPreview() {
            const tbody = document.querySelector('#previewTable tbody');
            tbody.innerHTML = '';
            AppState.previewData = [];
        }

        // ãƒªãƒãƒ¼ãƒ å®Ÿè¡Œï¼ˆFile System Access APIä½¿ç”¨ï¼‰
        document.getElementById('executeBtn').addEventListener('click', async () => {
            if (AppState.previewData.length === 0) {
                log('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å…ˆã«ç”Ÿæˆã—ã¦ãã ã•ã„', 'warning');
                alert('å…ˆã«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            // File System Access APIã®å¯¾å¿œãƒã‚§ãƒƒã‚¯
            if (!('showDirectoryPicker' in window)) {
                log('ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ãƒ•ã‚©ãƒ«ãƒ€ä¿å­˜ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“', 'error');
                alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ãƒ•ã‚©ãƒ«ãƒ€ã¸ã®ç›´æ¥ä¿å­˜ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚\nChromeã€Edgeã€Operaç­‰ã®æœ€æ–°ç‰ˆã‚’ã”ä½¿ç”¨ãã ã•ã„ã€‚');
                return;
            }

            try {
                // ä¿å­˜å…ˆãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠ
                log('ä¿å­˜å…ˆãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠã—ã¦ãã ã•ã„...');
                const dirHandle = await window.showDirectoryPicker({
                    mode: 'readwrite'
                });

                log(`ä¿å­˜å…ˆãƒ•ã‚©ãƒ«ãƒ€: ${dirHandle.name}`);

                let successCount = 0;
                let errorCount = 0;
                const errors = [];

                // å„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒªãƒãƒ¼ãƒ ã—ã¦ä¿å­˜
                for (const item of AppState.previewData) {
                    try {
                        // æ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«åã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
                        const fileHandle = await dirHandle.getFileHandle(item.newName, { create: true });
                        const writable = await fileHandle.createWritable();

                        // å…ƒã®Fileã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ›¸ãè¾¼ã¿
                        await writable.write(item.file);
                        await writable.close();

                        successCount++;
                        log(`ä¿å­˜æˆåŠŸ: ${item.newName}`);
                    } catch (err) {
                        errorCount++;
                        const errMsg = `${item.oldName} â†’ ${item.newName}: ${err.message}`;
                        errors.push(errMsg);
                        log(errMsg, 'error');
                    }
                }

                // çµæœã‚’è¡¨ç¤º
                log(`ãƒªãƒãƒ¼ãƒ å®Œäº†: æˆåŠŸ ${successCount}ä»¶, å¤±æ•— ${errorCount}ä»¶`);

                if (errorCount === 0) {
                    alert(`âœ… ãƒªãƒãƒ¼ãƒ å®Œäº†ï¼\n\n${successCount}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚\nä¿å­˜å…ˆ: ${dirHandle.name}`);
                } else {
                    alert(`âš ï¸ ãƒªãƒãƒ¼ãƒ å®Œäº†ï¼ˆä¸€éƒ¨å¤±æ•—ï¼‰\n\næˆåŠŸ: ${successCount}ä»¶\nå¤±æ•—: ${errorCount}ä»¶\n\nè©³ç´°ã¯ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`);
                }

                // ãƒã‚¹ã‚±ãƒƒãƒˆã¨ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ã‚¯ãƒªã‚¢
                AppState.basket = [];
                AppState.selectedBasketIndices.clear();
                renderBasket();
                clearPreview();

            } catch (err) {
                if (err.name === 'AbortError') {
                    log('ãƒ•ã‚©ãƒ«ãƒ€é¸æŠãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ', 'warning');
                } else {
                    log(`ã‚¨ãƒ©ãƒ¼: ${err.message}`, 'error');
                    alert(`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:\n${err.message}`);
                }
            }
        });


        // ãƒ•ã‚©ãƒ«ãƒ€ã‹ã‚‰JSONç”Ÿæˆ
        document.getElementById('generateJsonFromFolderBtn').addEventListener('click', () => {
            // ãƒ•ã‚©ãƒ«ãƒ€é¸æŠç”¨ã®éš ã—inputã‚’ä½œæˆ
            const folderInput = document.createElement('input');
            folderInput.type = 'file';
            folderInput.setAttribute('webkitdirectory', '');
            folderInput.setAttribute('directory', '');
            folderInput.setAttribute('multiple', '');

            folderInput.addEventListener('change', async (e) => {
                const files = Array.from(e.target.files);

                // ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ãƒ•ã‚£ãƒ«ã‚¿
                const imageFiles = files.filter(file =>
                    file.type.startsWith('image/')
                );

                if (imageFiles.length === 0) {
                    log('ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ', 'warning');
                    alert('é¸æŠã—ãŸãƒ•ã‚©ãƒ«ãƒ€ã«ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
                    return;
                }

                log(`${imageFiles.length}å€‹ã®ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œå‡ºã—ã¾ã—ãŸ`);

                // JSONç”Ÿæˆ
                const exportData = {
                    export_date: new Date().toISOString(),
                    folder_path: imageFiles[0].webkitRelativePath.split('/').slice(0, -1).join('/'),
                    total_count: imageFiles.length,
                    items: []
                };

                // ãƒ•ã‚¡ã‚¤ãƒ«åã®è‡ªç„¶é †ã‚½ãƒ¼ãƒˆ
                imageFiles.sort((a, b) => {
                    return a.name.localeCompare(b.name, undefined, { numeric: true, sensitivity: 'base' });
                });

                imageFiles.forEach((file, index) => {
                    const fileName = file.name;
                    const filePath = file.webkitRelativePath;

                    // ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰ãƒ©ãƒ™ãƒ«ã‚’æŠ½å‡º
                    const label = extractLabelFromFilename(fileName);

                    // ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰ã‚°ãƒ«ãƒ¼ãƒ—ç•ªå·ã‚’æŠ½å‡ºï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
                    const group = extractGroupFromFilename(fileName);

                    exportData.items.push({
                        order: index + 1,
                        file_name: fileName,
                        file_path: filePath,
                        label: label || 'ä¸æ˜',
                        group: group || 1
                    });
                });

                // JSONå‡ºåŠ›
                const filename = `photobook_export_${new Date().toISOString().replace(/[:.]/g, '-').split('T')[0]}.json`;
                downloadFile(JSON.stringify(exportData, null, 2), filename, 'application/json');

                log(`ãƒ•ã‚©ãƒ«ãƒ€ã‹ã‚‰JSONç”Ÿæˆå®Œäº†: ${filename} (${exportData.total_count}ä»¶)`);
                alert(`${exportData.total_count}ä»¶ã®ç”»åƒæƒ…å ±ã‚’JSONå‡ºåŠ›ã—ã¾ã—ãŸã€‚\n${filename}`);
            });

            folderInput.click();
        });

        // ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰ãƒ©ãƒ™ãƒ«ã‚’æŠ½å‡ºã™ã‚‹é–¢æ•°
        function extractLabelFromFilename(filename) {
            // ãƒ‘ã‚¿ãƒ¼ãƒ³1: V-1_å…¨æ™¯_001.jpg â†’ "å…¨æ™¯"
            // ãƒ‘ã‚¿ãƒ¼ãƒ³2: IMG_æ¥å†™_05.jpg â†’ "æ¥å†™"
            // ãƒ‘ã‚¿ãƒ¼ãƒ³3: å…¨æ™¯_001.jpg â†’ "å…¨æ™¯"

            // ã¾ãšæ‹¡å¼µå­ã‚’é™¤å»
            const nameWithoutExt = filename.replace(/\.[^.]+$/, '');

            // ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ã§åˆ†å‰²
            const parts = nameWithoutExt.split('_');

            if (parts.length >= 2) {
                // æœ€å¾Œã®éƒ¨åˆ†ãŒæ•°å­—ã®ã¿ã®å ´åˆã€ãã®å‰ã®éƒ¨åˆ†ã‚’ãƒ©ãƒ™ãƒ«ã¨ã™ã‚‹
                const lastPart = parts[parts.length - 1];
                if (/^\d+$/.test(lastPart)) {
                    // æœ€å¾ŒãŒæ•°å­—ãªã‚‰ã€ãã®å‰ã‚’ãƒ©ãƒ™ãƒ«ã¨ã™ã‚‹
                    return parts[parts.length - 2];
                } else {
                    // æœ€å¾ŒãŒæ•°å­—ã§ãªã„ãªã‚‰ã€æœ€å¾Œã‚’ãƒ©ãƒ™ãƒ«ã¨ã™ã‚‹
                    return lastPart;
                }
            } else if (parts.length === 1) {
                // ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ãŒãªã„å ´åˆã¯ã€ãƒ•ã‚¡ã‚¤ãƒ«åå…¨ä½“ã‚’ãƒ©ãƒ™ãƒ«ã¨ã™ã‚‹
                return nameWithoutExt;
            }

            return null;
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰ã‚°ãƒ«ãƒ¼ãƒ—ç•ªå·ã‚’æŠ½å‡ºã™ã‚‹é–¢æ•°
        function extractGroupFromFilename(filename) {
            // ãƒ‘ã‚¿ãƒ¼ãƒ³: V-1_å…¨æ™¯_001.jpg â†’ ã‚°ãƒ«ãƒ¼ãƒ—1
            const match = filename.match(/V-(\d+)_/);
            if (match) {
                return parseInt(match[1]);
            }
            return null;
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type: type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
        document.addEventListener('keydown', (e) => {
            // æ•°å­—ã‚­ãƒ¼ 1-9 ã§ãƒ©ãƒ™ãƒ«é©ç”¨
            if (e.key >= '1' && e.key <= '9') {
                const number = parseInt(e.key);
                if (AppState.labelPresets[number]) {
                    e.preventDefault();
                    applyLabelToSelected(AppState.labelPresets[number]);
                }
            }

            // Delete ã‚­ãƒ¼ã§é¸æŠã‚¯ãƒªã‚¢
            if (e.key === 'Delete') {
                e.preventDefault();
                AppState.selectedImages.clear();
                document.querySelectorAll('.thumbnail-item').forEach(el => {
                    el.classList.remove('selected');
                });
                log('ç”»åƒã®é¸æŠã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
            }
        });

        // åˆæœŸåŒ–
        log('ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•ï¼ˆHTMLç‰ˆï¼‰');
        log('ãƒ•ã‚©ãƒ«ãƒ€ã‚’é–‹ããƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦é–‹å§‹ã—ã¦ãã ã•ã„');
    </script>
</body>
</html>
